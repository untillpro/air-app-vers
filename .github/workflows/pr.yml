name: Validate Version Manifest

on:
  pull_request_target:
    branches:
      - main

jobs:
  check-author:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR author is in DevOps_releasep team
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REPOREADING_TOKEN }}
          script: |
            const author = context.payload.pull_request.user.login;
            const { data } = await github.rest.teams.getMembershipForUserInOrg({
              org: context.repo.owner,
              team_slug: 'DevOps_releasep',
              username: author
            }).catch(() => ({ data: null }));

            if (!data || data.state !== 'active') {
              core.setFailed(`${author} is not a member of DevOps_releasep team`);
            }

  validate:
    needs: check-author
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Run tests
        run: python -m unittest discover scripts -v

      - name: Validate manifests
        id: validate
        run: python scripts/validate.py

      - name: Comment PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '';

            if (${{ steps.validate.outcome == 'success' }}) {
              comment = '✅ **Validation passed**\n\nAll manifest files are valid.';
            } else {
              const jobUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              comment = `❌ **Validation failed**\n\nPlease check the workflow logs for details:\n${jobUrl}`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  auto-merge:
    needs: validate
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash'
            });
